FROM node:20-alpine AS base
RUN npm cache clean --force

# Envirionment variables
ARG NODE_ENV
ARG PORT
ARG CORS_ORIGIN
ARG MONGODB_URI
ARG REDIS_URL
ARG REDIRECT_URL
ARG COOKIE_KEY
ARG REFRESH_KEY
ARG KEYCLOAK_SERVER_URL
ARG KEYCLOAK_REALM
ARG KEYCLOAK_CLIENT_ID
ARG KEYCLOAK_ADMIN_USER_NAME
ARG KEYCLOAK_ADMIN_PASSWORD

ENV NODE_ENV=$NODE_ENV
ENV PORT=$PORT
ENV CORS_ORIGIN=$CORS_ORIGIN
ENV MONGODB_URI=$MONGODB_URI
ENV REDIS_URL=$REDIS_URL
ENV REDIRECT_URL=$REDIRECT_URL
ENV COOKIE_KEY=$COOKIE_KEY
ENV REFRESH_KEY=$REFRESH_KEY
ENV KEYCLOAK_SERVER_URL=$KEYCLOAK_SERVER_URL
ENV KEYCLOAK_REALM=$KEYCLOAK_REALM
ENV KEYCLOAK_CLIENT_ID=$KEYCLOAK_CLIENT_ID
ENV KEYCLOAK_ADMIN_USER_NAME=$KEYCLOAK_ADMIN_USER_NAME
ENV KEYCLOAK_ADMIN_PASSWORD=$KEYCLOAK_ADMIN_PASSWORD

# Build Dev
FROM base AS builder
WORKDIR /app
COPY ./server .
RUN npm install
RUN npm run build

# Start the api server
FROM builder AS runner
WORKDIR /app
CMD node ./dist/index.js
